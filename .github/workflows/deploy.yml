name: Deploy to VPS

on:
  push:
    branches:
      - main  # Trigger deployment when changes are pushed to the main branch

jobs:
  build:
    runs-on: ubuntu-latest  # Use the latest Ubuntu for the CI environment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.17.0'  # Specify the Node.js version you want to use

      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps

      - name: Build project
        run: |
          npm run build

      - name: Upload build to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # Set this as a secret in GitHub
          VPS_USER: admin
          VPS_HOST: 147.93.106.12
          VPS_PATH: /home/admin/sanatan-website
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key
          ssh -i private_key -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "cd /home/admin/sanatan-website && npm run start"

          - name: Restart application on VPS
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            VPS_USER: admin
            VPS_HOST: 147.93.106.12
          run: |
            echo "$SSH_PRIVATE_KEY" > private_key
            chmod 600 private_key
            ssh -i private_key -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'EOF'
              echo "ðŸ”ª Killing old process..."
              fuser -k 3000/tcp || true
        
              echo "ðŸš€ Restarting app..."
              cd /home/admin/sanatan-website
              npm install --legacy-peer-deps
              PORT=3001 nohup npm run start > out.log 2>&1 &
            EOF
        
        